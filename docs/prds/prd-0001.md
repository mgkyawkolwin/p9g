# Product Requirements Document (PRD)
**Project Name:** P9G - Prepaid Package Module
**Version:** 1.1
**Author:** Kyaw Ko Lwin
**Date:** 26/08/2025
**Status:** Draft
**BRD Reference:** BRD_P9G_Prepaid_Expansion v1.0

## 1. Introduction
This document details the functional and non-functional requirements for the new Prepaid Package module. This module will manage the lifecycle of prepaid packages, from sale to consumption, enabling the business model expansion outlined in the BRD.

## 2. User Stories & Functional Requirements

### 2.1 Epic: Package Management
**User Story (US-01):** As a registered user, I want to create a new prepaid package so that I can sell it to a customer.
**Acceptance Criteria (AC):**
- [ ] A new `prepaid_packages` table exists in the database.
- [ ] A form is available to create a package with all required fields.
- [ ] Upon save, a success message is shown and the package is listed.

**User Story (US-02):** As a registered user, I want to view a list of all prepaid packages.
**AC:**
- [ ] A page displays a table of packages with key details: ID, Owner, Days, Remaining, Status.
- [ ] The list can be searched and filtered.

**User Story (US-03):** As a registered user, I want to edit a prepaid package's details (e.g., start date) before any days are used.
**AC:**
- [ ] Editable packages have an "Edit" button.
- [ ] Packages with `usage > 0` cannot have their `days` or `start_date` edited.

### 2.2 Epic: Reservation Integration
**User Story (US-04):** As a registered user, I want to apply a prepaid package to a reservation so that the stay is paid for with days instead of cash.
**AC:**
- [ ] The reservation form has a field for "Prepaid ID".
- [ ] The field validates that the ID exists and is active.
- [ ] The reservation type is set to "Prepaid" upon successful application.

**User Story (US-05):** As a system, I must automatically deduct used days from a prepaid package upon check-in to ensure the balance is always accurate.
**AC:**
- [ ] The deduction process runs automatically when a reservation is checked in.
- [ ] The number of nights stayed is subtracted from the package's `remaining` balance.
- [ ] The package's `usage` counter is incremented by the number of nights.
- [ ] If the package has insufficient days, check-in is prevented and an error is shown.

## 3. UI/UX Specifications

### 3.1 Prepaid Package Form Fields
The form for creating/editing a package shall include the following fields:

| Field Name | Type | Required | Default Value | Validation |
| :--- | :--- | :--- | :--- | :--- |
| Customer (Purchaser) | Dropdown | Yes | - | Must be an existing Member ID |
| Start Date | Date Picker | Yes | Today | Must be today or a future date |
| Package Days | Number | Yes | 90 | Must be > 0 |
| Amount | Decimal | Yes | 0 | >= 0 |
| Currency | Dropdown | Yes | KWR | ISO 3-letter code |
| Payment Mode | Dropdown | Yes | Cash | Cash, BankTransfer, CreditCard |

### 3.2 Messages
| Message Type | Text |
| :--- | :--- |
| Success | Prepaid package saved successfully. |
| Validation Error | Prepaid package cannot be saved. Please check your inputs. |
| Insufficient Days | Check-in failed. Prepaid package [ID] has insufficient days. |
| Not Found | The entered Prepaid ID was not found. |

## 4. Data Definitions & Business Rules

### 4.1 Key Entities
*   **Prepaid Package:** The main entity. Key attributes: `id` (UUID), `customer_id` (FK to Members), `days`, `usage`, `remaining`, `status`.
*   **Status:** Calculated field.
    *   **Active:** `remaining > 0` AND `current_date <= end_date`
    *   **Exhausted:** `remaining == 0`
    *   **Expired:** `current_date > end_date`

### 4.2 Critical Business Rules
*   **BR-01 (Deduction):** Days are deducted on **check-in**, not on reservation creation. The number of nights is calculated as `(checkout_date - checkin_date)`.
*   **BR-02 (Validation):** A package can only be applied to a reservation if its status is **Active**.
*   **BR-03 (Integrity):** The equation `remaining = days - usage` must always hold true. This will be enforced at the application level with database transactions to prevent race conditions.

## 5. Non-Functional Requirements

| Requirement Category | Specification |
| :--- | :--- |
| **Performance** | • Page load time for the package list must be < 3 seconds with 1000 records.<br>• The deduction process must complete in < 2 seconds. |
| **Security** | • All functionality is behind authentication.<br>• API endpoints must be protected against SQL injection and XSS. |
| **Availability** | The module must be available during all business hours (06:00 - 23:00). |
| **Data Integrity** | The system must use database transactions for the deduction process to prevent over-subscription of package days. |

## 6. Out of Scope
*   Agent-specific functionality (will be handled by granting agents access to this module).
*   Editing `days` or `start_date` after usage has begun.
*   Canceling a reservation and crediting days back to a package.

## 7. Open Questions
1.  What is the process if a guest checks out early? Do they get credited back? *(Answer for v1: No)*
2.  Should there be an admin override to manually adjust a package's balance? *(Answer for v1: No, requires future story)*

---
*This PRD is the primary reference document for the development and QA teams. Any changes must be versioned and communicated to all stakeholders.*